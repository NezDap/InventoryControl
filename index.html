<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistem Tabungan</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#0f0f14;
      --muted:#6b7280;         /* abu */
      --line:#e5e7eb;          /* abu muda */
      --accent:#9ca3af;        /* abu accent */
      --purple:#6d28d9;        /* ungu sekunder */
      --purple2:#7c3aed;
      --card:#ffffff;
      --shadow: 0 12px 35px rgba(17, 24, 39, .10);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    a{ color: var(--purple); text-decoration:none; }
    .wrap{ max-width:1100px; margin:0 auto; padding:22px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; border:1px solid var(--line); border-radius: var(--radius);
      background: var(--card); box-shadow: var(--shadow);
      position: sticky; top: 12px; z-index: 5;
    }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logoDot{
      width:14px; height:14px; border-radius:50%;
      background: var(--purple);
      box-shadow: 0 0 0 4px rgba(109,40,217,.15);
    }
    .brandTitle{ font-weight:800; letter-spacing:.2px; }
    .pill{
      border:1px solid var(--line);
      color: var(--muted);
      padding:8px 10px; border-radius:999px;
      font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .btn{
      border:1px solid var(--line);
      background: #fff;
      padding:10px 12px; border-radius:12px;
      cursor:pointer;
      font-weight:650;
      transition: transform .08s ease, box-shadow .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(17, 24, 39, .08); }
    .btn.primary{
      background: var(--purple);
      border-color: var(--purple);
      color:#fff;
    }
    .btn.danger{
      background:#fff;
      border-color:#fecaca;
      color:#b91c1c;
    }
    .btn.ghost{
      background: transparent;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      margin-top:18px;
    }
    @media (max-width: 940px){
      .grid{ grid-template-columns: 1fr; }
      .topbar{ position: static; }
    }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .card h2{ margin:0 0 8px; font-size:16px; }
    .muted{ color: var(--muted); font-size:13px; line-height:1.4; }
    .tabs{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:14px;
    }
    .tab{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      cursor:pointer;
      font-weight:650;
      color: var(--muted);
      background:#fff;
    }
    .tab.active{
      border-color: rgba(109,40,217,.35);
      color: var(--purple);
      background: rgba(109,40,217,.07);
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 640px){
      .kpis{ grid-template-columns: 1fr; }
    }
    .kpi{
      border:1px dashed rgba(109,40,217,.25);
      border-radius: 14px;
      padding:12px;
      background: rgba(109,40,217,.04);
    }
    .kpi .label{ color: var(--muted); font-size:12px; }
    .kpi .value{ font-size:18px; font-weight:800; margin-top:6px; }

    table{ width:100%; border-collapse: collapse; }
    th, td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      text-align:left;
      font-size:13px;
      vertical-align: top;
    }
    th{ color: var(--muted); font-weight:800; font-size:12px; letter-spacing:.3px; }
    tr:hover td{ background: rgba(156,163,175,.08); }
    .rowActions{ display:flex; gap:8px; }
    .tag{
      display:inline-flex;
      padding:6px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:750;
      border:1px solid var(--line);
      color: var(--muted);
      background:#fff;
    }
    .tag.purple{
      border-color: rgba(109,40,217,.35);
      color: var(--purple);
      background: rgba(109,40,217,.07);
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 640px){
      .formGrid{ grid-template-columns: 1fr; }
    }
    label{ display:block; font-size:12px; color: var(--muted); font-weight:800; margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius: 12px;
      outline:none;
      font-size:14px;
      background:#fff;
      color: var(--text);
    }
    textarea{ min-height: 90px; resize: vertical; }

    .footerActions{
      display:flex; gap:10px; justify-content:flex-end; margin-top:12px;
    }

    /* Modal */
    .modalMask{
      position:fixed; inset:0;
      background: rgba(15,15,20,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 50;
    }
    .modal{
      width: min(680px, 100%);
      border-radius: 18px;
      background:#fff;
      border:1px solid var(--line);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      padding:16px;
    }
    .modalHead{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .modalHead h3{ margin:0; font-size:16px; }
    .x{ border:none; background:transparent; cursor:pointer; font-size:22px; line-height:1; color: var(--muted); }

    /* Login */
    .center{
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 22px;
    }
    .loginCard{
      width:min(460px, 100%);
      border:1px solid var(--line);
      border-radius: 18px;
      background:#fff;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .loginTitle{ font-size:18px; font-weight:900; margin:0 0 6px; }
    .loginSub{ margin:0; color: var(--muted); font-size:13px; line-height:1.4; }
    .loginActions{ display:flex; gap:10px; margin-top:12px; justify-content:flex-end; }

    /* Loader overlay + Mascot (Kuromi-style, generic, non-copyrighted) */
    .loaderMask{
      position: fixed; inset: 0;
      display:none;
      align-items: center; justify-content:center;
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(6px);
      z-index: 100;
    }
    .loaderCard{
      width: 320px;
      border:1px solid var(--line);
      background:#fff;
      border-radius: 18px;
      padding: 14px;
      box-shadow: var(--shadow);
      text-align:center;
    }
    .loaderText{ font-weight:800; margin-top: 10px; }
    .loaderSub{ font-size:12px; color: var(--muted); margin-top: 4px; }

    /* Cute mischievous mascot */
    .mascot{
      width: 120px; height: 120px;
      margin: 0 auto;
      position: relative;
      animation: floaty 1.5s ease-in-out infinite;
    }
    @keyframes floaty {
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-7px); }
    }
    .head{
      position:absolute; inset: 20px 18px 18px 18px;
      border-radius: 24px;
      background: #111827;
      box-shadow: 0 14px 30px rgba(17,24,39,.18);
    }
    .ear{
      position:absolute; top: 0;
      width: 28px; height: 48px;
      background:#111827;
      border-radius: 20px 20px 12px 12px;
      transform-origin: bottom center;
    }
    .ear.left{ left: 18px; transform: rotate(-12deg); animation: earWiggle 1.2s ease-in-out infinite; }
    .ear.right{ right: 18px; transform: rotate(12deg); animation: earWiggle 1.2s ease-in-out infinite reverse; }
    @keyframes earWiggle{
      0%,100%{ transform: rotate(var(--rot)); }
      50%{ transform: rotate(calc(var(--rot) * -1)); }
    }
    .ear.left{ --rot:-12deg; }
    .ear.right{ --rot:12deg; }

    .face{
      position:absolute; left: 24px; right: 24px; top: 40px; bottom: 24px;
      border-radius: 18px;
      background: #fff;
    }
    .eye{
      position:absolute; top: 22px;
      width: 12px; height: 12px; border-radius: 50%;
      background:#111827;
    }
    .eye.left{ left: 18px; }
    .eye.right{ right: 18px; }
    .mouth{
      position:absolute; left: 50%; top: 46px;
      width: 18px; height: 10px;
      border: 3px solid #111827;
      border-top: none;
      border-left: none;
      border-right: none;
      transform: translateX(-50%);
      border-radius: 0 0 20px 20px;
    }
    .moodAngry .mouth{
      border-radius: 20px 20px 0 0;
      border-bottom: none;
      border-top: 3px solid #111827;
      top: 48px;
    }
    .blush{
      position:absolute; top: 34px;
      width: 14px; height: 8px; border-radius: 999px;
      background: rgba(124,58,237,.25);
      filter: blur(.1px);
    }
    .blush.left{ left: 8px; }
    .blush.right{ right: 8px; }
    .horn{
      position:absolute; top: 12px; left: 50%;
      width: 14px; height: 14px;
      border-radius: 4px;
      background: var(--purple);
      transform: translateX(-50%) rotate(15deg);
      box-shadow: 0 0 0 4px rgba(109,40,217,.14);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow);
      display:none;
      z-index: 200;
      font-weight: 700;
      font-size: 13px;
    }
    .toast.bad{ border-color:#fecaca; color:#b91c1c; }
    .toast.good{ border-color:rgba(109,40,217,.35); color: var(--purple); }
  </style>
</head>

<body>
  <!-- Loader -->
  <div class="loaderMask" id="loaderMask">
    <div class="loaderCard">
      <div class="mascot" id="mascot">
        <div class="ear left"></div>
        <div class="ear right"></div>
        <div class="head">
          <div class="horn"></div>
          <div class="face">
            <div class="eye left"></div>
            <div class="eye right"></div>
            <div class="blush left"></div>
            <div class="blush right"></div>
            <div class="mouth"></div>
          </div>
        </div>
      </div>
      <div class="loaderText" id="loaderText">Memuatâ€¦</div>
      <div class="loaderSub" id="loaderSub">Mascot mode: imut dulu, marah belakangan.</div>
      <!-- Slot bila kamu ingin pakai GIF Kuromi milikmu sendiri:
           <img src="PASTE_URL_GIF_KUROMI_MILIKMU" style="width:120px;height:120px;border-radius:16px;" />
      -->
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- LOGIN VIEW -->
  <div class="center" id="loginView" style="display:none;">
    <div class="loginCard">
      <div class="brand" style="margin-bottom:10px;">
        <div class="logoDot"></div>
        <div>
          <div class="brandTitle">Tabungan Kita Berdua</div>
          <div class="muted">Nabung â€¢ Pemakaian â€¢ Goals Kita</div>
        </div>
      </div>
      <h1 class="loginTitle">Login</h1>
      <p class="loginSub">Masuk dengan <b>ID</b> dan <b>Password</b></p>

      <div class="formGrid" style="margin-top:14px;">
        <div>
          <label>User ID</label>
          <input id="loginUserId" placeholder="contoh: admin" />
        </div>
        <div>
          <label>Password</label>
          <input id="loginPassword" type="password" placeholder="contoh: admin123" />
        </div>
      </div>
      <div class="loginActions">
        <button class="btn primary" onclick="handleLogin()">Login</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        Tidak ada Registrasi akun: <span class="tag purple">Khusus kita berdua</span>
      </div>
    </div>
  </div>

  <!-- APP VIEW -->
  <div class="wrap" id="appView" style="display:none;">
    <div class="topbar">
      <div class="brand">
        <div class="logoDot"></div>
        <div>
          <div class="brandTitle">Tabungan Kita Berdua</div>
          <div class="muted" id="welcomeText">â€”</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div class="pill">
          <span>Session</span>
          <span class="tag purple" id="sessionUser">â€”</span>
        </div>
        <button class="btn" onclick="refreshAll()">Sync</button>
        <button class="btn danger" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</div>
      <div class="tab" data-tab="inflow" onclick="switchTab('inflow')">Cash Inflow</div>
      <div class="tab" data-tab="outbound" onclick="switchTab('outbound')">Cash Outbound</div>
      <div class="tab" data-tab="goals" onclick="switchTab('goals')">Forecasting Goals</div>
    </div>

    <div class="grid">
      <div class="card" id="mainCard">
        <!-- Dynamic content -->
      </div>

      <div class="card">
        <h2>Quick Add</h2>
        <div class="muted">Tambah transaksi cepat (akan masuk sesuai tab aktif).</div>

        <div class="formGrid">
          <div>
            <label>Tanggal</label>
            <input id="qaDate" type="date" />
          </div>
          <div>
            <label>Amount</label>
            <input id="qaAmount" type="number" min="0" step="1" placeholder="contoh: 25000" />
          </div>
          <div>
            <label>Kategori</label>
            <input id="qaCategory" placeholder="contoh: Gaji / Makan / Transport" />
          </div>
          <div>
            <label>Catatan</label>
            <input id="qaNote" placeholder="opsional" />
          </div>
        </div>

        <div class="footerActions">
          <button class="btn primary" onclick="quickAdd()">Tambah</button>
        </div>

        <div style="margin-top:14px;">
          <h2 style="margin-bottom:6px;">Mascot Mood</h2>
          <div class="muted">Loader imut atau marah</div>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn" onclick="setMascotMood('cute')">Imut</button>
            <button class="btn" onclick="setMascotMood('angry')">Marah</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalMask" id="modalMask">
    <div class="modal">
      <div class="modalHead">
        <h3 id="modalTitle">â€”</h3>
        <button class="x" onclick="closeModal()">Ã—</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>


  <!-- Config: isi SUPABASE_URL dan SUPABASE_ANON_KEY di config.js -->
  <script src="./config.js"></script>
  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  // =========================
  // Config + Supabase client
  // =========================
  const APP = window.APP_CONFIG || {};
  const SUPABASE_URL = APP.SUPABASE_URL || '';
  const SUPABASE_ANON_KEY = APP.SUPABASE_ANON_KEY || '';
  const ID_EMAIL_SUFFIX = APP.ID_EMAIL_SUFFIX || '@tabungan.local';
  const AVG_MONTHS_FOR_FORECAST = Number(APP.AVG_MONTHS_FOR_FORECAST || 3);

  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    console.error('Supabase config missing. Pastikan config.js terisi (SUPABASE_URL & SUPABASE_ANON_KEY).');
  }

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // =========================
  // State
  // =========================
  const state = {
    session: null,
    userId: null,     // local part dari email
    fullName: null,   // dari profiles.full_name
    activeTab: 'dashboard',
    inflow: [],
    outbound: [],
    goals: [],
    summary: { totalIn:0, totalOut:0, balance:0, avgMonthlyNet:0 },
    mascotMood: 'cute'
  };

  // =========================
  // Helpers: UI
  // =========================
  function money(n){
    try{
      return new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 }).format(Number(n||0));
    } catch(e){
      return 'Rp ' + (Number(n||0).toFixed(0));
    }
  }
  function todayISO(){
    const d = new Date();
    const pad = (x)=> String(x).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function showLoader(text='Memuat...', sub='Sedang sinkron dataâ€¦'){
    const mask = document.getElementById('loaderMask');
    document.getElementById('loaderText').textContent = text;
    document.getElementById('loaderSub').textContent = sub;
    setMascotMood(state.mascotMood, true);
    mask.style.display = 'flex';
  }
  function hideLoader(){
    document.getElementById('loaderMask').style.display = 'none';
  }
  function toast(msg, kind='good'){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + (kind === 'bad' ? 'bad' : 'good');
    t.style.display = 'block';
    setTimeout(()=> t.style.display = 'none', 2600);
  }
  function setMascotMood(mood, silent=false){
    state.mascotMood = mood;
    const m = document.getElementById('mascot');
    m.classList.remove('moodAngry');
    if (mood === 'angry') m.classList.add('moodAngry');
    if (!silent) toast('Mascot mood: ' + (mood === 'angry' ? 'marah ðŸ˜¤' : 'imut ðŸ¥º'), 'good');
  }

  function openModal(title, bodyHTML){
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = bodyHTML;
    document.getElementById('modalMask').style.display = 'flex';
  }
  function closeModal(){
    document.getElementById('modalMask').style.display = 'none';
  }

  function esc(s){
    s = String(s ?? '');
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function emailFromUserId(userId){
    const v = String(userId || '').trim();
    if (!v) return '';
    if (v.includes('@')) return v;
    return v + ID_EMAIL_SUFFIX;
  }
  function userIdFromEmail(email){
    const e = String(email || '');
    const i = e.indexOf('@');
    return i >= 0 ? e.slice(0,i) : e;
  }

  // =========================
  // DB mappers
  // =========================
  function txFromRow(r){
    return {
      txId: r.id,
      userId: r.user_id,
      date: r.date,
      amount: Number(r.amount || 0),
      category: r.category || '',
      note: r.note || '',
      createdAt: r.created_at || '',
      updatedAt: r.updated_at || ''
    };
  }
  function goalFromRow(r){
    return {
      goalId: r.id,
      userId: r.user_id,
      goalName: r.goal_name,
      goalAmount: Number(r.goal_amount || 0),
      targetDate: r.target_date,
      lastCalcAt: r.last_calc_at,
      currentBalanceAtCalc: Number(r.current_balance_at_calc || 0),
      monthsRemainingAtCalc: Number(r.months_remaining_at_calc || 0),
      requiredMonthlyNet: Number(r.required_monthly_net || 0),
      projectedMonthlyNet: Number(r.projected_monthly_net || 0),
      projectedBalanceAtTarget: Number(r.projected_balance_at_target || 0),
      status: r.status || ''
    };
  }

  // =========================
  // Auth flow
  // =========================
  async function ensureProfile(user, fallbackName){
    try{
      const { data, error } = await sb.from('profiles')
        .select('full_name')
        .eq('id', user.id)
        .maybeSingle();
      if (error) throw error;
      if (!data){
        // create
        const { error:insErr } = await sb.from('profiles')
          .insert({ id: user.id, full_name: fallbackName || userIdFromEmail(user.email) });
        if (insErr) throw insErr;
        return fallbackName || userIdFromEmail(user.email);
      }
      return data.full_name || (fallbackName || userIdFromEmail(user.email));
    } catch(e){
      console.warn('ensureProfile failed:', e);
      return fallbackName || userIdFromEmail(user.email);
    }
  }

  async function handleLogin(){
    const userId = document.getElementById('loginUserId').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!userId || !password) return toast('ID dan password wajib diisi.', 'bad');

    showLoader('Loginâ€¦', 'Memverifikasi akunâ€¦');
    try{
      const email = emailFromUserId(userId);
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) throw error;

      state.session = data.session;
      state.userId = userIdFromEmail(data.user.email);

      state.fullName = await ensureProfile(data.user, state.userId);

      await bootstrapApp();
      toast('Login sukses âœ…', 'good');
    } catch(e){
      toast(e.message || String(e), 'bad');
      console.error(e);
    } finally {
      hideLoader();
    }
  }

  async function logout(){
    showLoader('Logoutâ€¦','Menutup sessionâ€¦');
    try{
      await sb.auth.signOut();
    } catch(e){}
    state.session = null;
    state.userId = null;
    state.fullName = null;
    hideLoader();
    showLogin();
  }

  async function autoLogin(){
    showLoader('Memulihkan sessionâ€¦','Cek tokenâ€¦');
    try{
      const { data, error } = await sb.auth.getSession();
      if (error) throw error;
      const session = data.session;
      if (!session){
        showLogin(); return;
      }
      state.session = session;
      const user = session.user;
      state.userId = userIdFromEmail(user.email);
      state.fullName = await ensureProfile(user, state.userId);
      await bootstrapApp();
    } catch(e){
      console.warn(e);
      showLogin();
    } finally {
      hideLoader();
    }
  }

  function showLogin(){
    document.getElementById('loginView').style.display = 'flex';
    document.getElementById('appView').style.display = 'none';
    // demo convenience (hapus kalau tidak mau)
    document.getElementById('loginUserId').value = 'admin';
    document.getElementById('loginPassword').value = 'admin123';
  }
  function showApp(){
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('appView').style.display = 'block';
    document.getElementById('sessionUser').textContent = state.userId || 'â€”';
    document.getElementById('welcomeText').textContent = `Halo, ${state.fullName || state.userId}.`;
  }

  // =========================
  // Data functions (Supabase)
  // =========================
  async function apiGetSummary(){
    const { data, error } = await sb.rpc('get_summary', { months_n: AVG_MONTHS_FOR_FORECAST });
    if (error) throw error;
    return {
      totalIn: Number(data.total_in || 0),
      totalOut: Number(data.total_out || 0),
      balance: Number(data.balance || 0),
      avgMonthlyNet: Number(data.avg_monthly_net || 0)
    };
  }

  async function apiListTransactions(type){
    const { data, error } = await sb.from('transactions')
      .select('id,user_id,date,amount,category,note,created_at,updated_at')
      .eq('type', type)
      .order('date', { ascending:false })
      .limit(1000);
    if (error) throw error;
    return (data || []).map(txFromRow);
  }

  async function apiAddTransaction(type, payload){
    const insertRow = {
      user_id: state.session?.user?.id,
      type,
      date: payload.date,
      amount: Number(payload.amount || 0),
      category: payload.category || '',
      note: payload.note || ''
    };
    const { data, error } = await sb.from('transactions')
      .insert(insertRow)
      .select('id,user_id,date,amount,category,note,created_at,updated_at')
      .single();
    if (error) throw error;
    return txFromRow(data);
  }

  async function apiUpdateTransaction(type, txId, payload){
    const updRow = {
      date: payload.date,
      amount: Number(payload.amount || 0),
      category: payload.category || '',
      note: payload.note || ''
    };
    const { error } = await sb.from('transactions')
      .update(updRow)
      .eq('id', txId)
      .eq('type', type);
    if (error) throw error;
    return true;
  }

  async function apiDeleteTransaction(type, txId){
    const { error } = await sb.from('transactions')
      .delete()
      .eq('id', txId)
      .eq('type', type);
    if (error) throw error;
    return true;
  }

  async function apiListGoals(){
    const { data, error } = await sb.from('goals')
      .select('id,user_id,goal_name,goal_amount,target_date,last_calc_at,current_balance_at_calc,months_remaining_at_calc,required_monthly_net,projected_monthly_net,projected_balance_at_target,status,created_at')
      .order('created_at', { ascending:false })
      .limit(200);
    if (error) throw error;
    return (data || []).map(goalFromRow);
  }

  async function apiAddGoal(payload){
    const row = {
      user_id: state.session?.user?.id,
      goal_name: payload.goalName,
      goal_amount: Number(payload.goalAmount || 0),
      target_date: payload.targetDate
    };
    const { data, error } = await sb.from('goals')
      .insert(row)
      .select('id,user_id,goal_name,goal_amount,target_date,last_calc_at,current_balance_at_calc,months_remaining_at_calc,required_monthly_net,projected_monthly_net,projected_balance_at_target,status,created_at')
      .single();
    if (error) throw error;
    return goalFromRow(data);
  }

  async function apiUpdateGoalCalc(goalId, calc){
    const row = {
      last_calc_at: new Date().toISOString(),
      current_balance_at_calc: calc.currentBalance,
      months_remaining_at_calc: calc.monthsRemaining,
      required_monthly_net: calc.requiredMonthlyNet,
      projected_monthly_net: calc.projectedMonthlyNet,
      projected_balance_at_target: calc.projectedBalanceAtTarget,
      status: calc.status
    };
    const { error } = await sb.from('goals')
      .update(row)
      .eq('id', goalId);
    if (error) throw error;
    return true;
  }

  async function apiDeleteGoal(goalId){
    const { error } = await sb.from('goals')
      .delete()
      .eq('id', goalId);
    if (error) throw error;
    return true;
  }

  // =========================
  // Forecast logic (mirror GAS)
  // =========================
  function computeForecast(goalAmount, targetDateISO){
    const currentBalance = state.summary.balance;
    const projectedMonthlyNet = state.summary.avgMonthlyNet;

    const today = new Date();
    const target = new Date(targetDateISO + 'T00:00:00');
    const days = Math.floor((target.getTime() - today.getTime()) / (1000*60*60*24));
    const monthsRemaining = days <= 0 ? 0 : Math.max(1, Math.ceil(days / 30.4375));

    const gap = Number(goalAmount || 0) - Number(currentBalance || 0);
    const requiredMonthlyNet = monthsRemaining <= 0 ? (gap > 0 ? gap : 0) : Math.max(0, gap / monthsRemaining);

    const projectedBalanceAtTarget = Number(currentBalance || 0) + Number(projectedMonthlyNet || 0) * monthsRemaining;

    let status;
    if (monthsRemaining <= 0) {
      status = (currentBalance >= goalAmount) ? 'âœ… Target tercapai' : 'â›” Target lewat, belum tercapai';
    } else if (projectedBalanceAtTarget >= goalAmount) {
      status = 'âœ… On track (berdasarkan rata-rata net bulanan)';
    } else {
      const extra = (goalAmount - projectedBalanceAtTarget) / monthsRemaining;
      status = `âš ï¸ Perlu tambah net +${Math.ceil(extra)} / bulan`;
    }

    return {
      currentBalance,
      projectedMonthlyNet,
      monthsRemaining,
      requiredMonthlyNet,
      projectedBalanceAtTarget,
      status
    };
  }

  // =========================
  // Data Load
  // =========================
  async function bootstrapApp(){
    showApp();
    document.getElementById('qaDate').value = todayISO();
    await refreshAll();
    switchTab('dashboard');
  }

  async function refreshAll(){
    showLoader('Syncâ€¦', 'Ambil data inflow/outbound/goalsâ€¦');
    try{
      const [sum, inflow, outbound, goals] = await Promise.all([
        apiGetSummary(),
        apiListTransactions('inflow'),
        apiListTransactions('outbound'),
        apiListGoals()
      ]);

      state.summary = sum;
      state.inflow = inflow;
      state.outbound = outbound;
      state.goals = goals;

      render();
      toast('Data tersinkron âœ…', 'good');
    } catch(e){
      toast(e.message || String(e), 'bad');
      console.error(e);
    } finally {
      hideLoader();
    }
  }

  // =========================
  // Tabs + Render
  // =========================
  function switchTab(tab){
    state.activeTab = tab;
    document.querySelectorAll('.tab').forEach(x=>{
      x.classList.toggle('active', x.dataset.tab === tab);
    });
    render();
  }

  function render(){
    const main = document.getElementById('mainCard');
    if (state.activeTab === 'dashboard'){
      main.innerHTML = renderDashboard();
    } else if (state.activeTab === 'inflow'){
      main.innerHTML = renderTxTable('inflow');
    } else if (state.activeTab === 'outbound'){
      main.innerHTML = renderTxTable('outbound');
    } else if (state.activeTab === 'goals'){
      main.innerHTML = renderGoals();
    }
  }

  function AVG_MONTHS_FOR_FORECAST_UI(){
    return AVG_MONTHS_FOR_FORECAST;
  }

  function renderDashboard(){
    const s = state.summary || {};
    return `
      <h2>Dashboard</h2>
      <div class="muted">Ringkasan keuangan kamu, plus indikator forecasting sederhana berbasis rata-rata net bulanan.</div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">Total Inflow</div>
          <div class="value">${money(s.totalIn)}</div>
        </div>
        <div class="kpi">
          <div class="label">Total Outbound</div>
          <div class="value">${money(s.totalOut)}</div>
        </div>
        <div class="kpi">
          <div class="label">Balance Saat Ini</div>
          <div class="value">${money(s.balance)}</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center;">
        <span class="tag purple">Avg Net/Bulan (â‰ˆ${AVG_MONTHS_FOR_FORECAST_UI()} bulan)</span>
        <span class="tag">${money(s.avgMonthlyNet)}</span>
        <span class="muted">*dipakai untuk proyeksi goals</span>
      </div>

      <div class="grid" style="grid-template-columns:1fr 1fr; margin-top:14px;">
        <div class="card" style="box-shadow:none;">
          <h2>Transaksi Terbaru (Inflow)</h2>
          ${renderMiniList(state.inflow.slice(0,6), 'inflow')}
        </div>
        <div class="card" style="box-shadow:none;">
          <h2>Transaksi Terbaru (Outbound)</h2>
          ${renderMiniList(state.outbound.slice(0,6), 'outbound')}
        </div>
      </div>
    `;
  }

  function renderMiniList(list, type){
    if (!list || list.length === 0) return `<div class="muted" style="margin-top:8px;">Belum ada data.</div>`;
    return `
      <table>
        <thead><tr>
          <th>Tanggal</th><th>Kategori</th><th>Amount</th>
        </tr></thead>
        <tbody>
          ${list.map(x=>`
            <tr>
              <td>${esc(x.date)}</td>
              <td>${esc(x.category || '-')}</td>
              <td><b>${money(x.amount)}</b></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn" onclick="switchTab('${type === 'inflow' ? 'inflow' : 'outbound'}')">Lihat semua</button>
      </div>
    `;
  }

  function renderTxTable(type){
    const title = type === 'inflow' ? 'Cash Inflow' : 'Cash Outbound';
    const list = type === 'inflow' ? state.inflow : state.outbound;

    return `
      <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px; flex-wrap:wrap;">
        <div>
          <h2 style="margin-bottom:6px;">${title}</h2>
          <div class="muted">Tambah, edit, hapus transaksi tanpa perlu buka database manual.</div>
        </div>
        <button class="btn primary" onclick="openTxModal('${type}')">+ Tambah</button>
      </div>

      <div style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Kategori</th>
              <th>Catatan</th>
              <th>Amount</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            ${(list && list.length ? list.map(tx => `
              <tr>
                <td>${esc(tx.date)}</td>
                <td>${esc(tx.category || '-')}</td>
                <td>${esc(tx.note || '-')}</td>
                <td><b>${money(tx.amount)}</b></td>
                <td>
                  <div class="rowActions">
                    <button class="btn" onclick="openTxModal('${type}', '${tx.txId}')">Edit</button>
                    <button class="btn danger" onclick="deleteTx('${type}','${tx.txId}')">Hapus</button>
                  </div>
                </td>
              </tr>
            `).join('') : `<tr><td colspan="5" class="muted">Belum ada data.</td></tr>`)}
          </tbody>
        </table>
      </div>
    `;
  }

  function renderGoals(){
    return `
      <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px; flex-wrap:wrap;">
        <div>
          <h2 style="margin-bottom:6px;">Forecasting Goals</h2>
          <div class="muted">
            Input target tabungan (goalAmount + targetDate). Sistem menghitung:
            required net/bulan & proyeksi berdasarkan rata-rata net bulanan.
          </div>
        </div>
        <button class="btn primary" onclick="openGoalModal()">+ Tambah Goal</button>
      </div>

      <div style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th>Goal</th>
              <th>Target</th>
              <th>Required Net/Bulan</th>
              <th>Proyeksi</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            ${(state.goals && state.goals.length ? state.goals.map(g => `
              <tr>
                <td>
                  <b>${esc(g.goalName)}</b><br/>
                  <span class="muted">Target date: ${esc(g.targetDate)}</span>
                </td>
                <td><b>${money(g.goalAmount)}</b></td>
                <td>${money(g.requiredMonthlyNet || 0)}</td>
                <td>
                  <span class="muted">Projected @ target:</span><br/>
                  <b>${money(g.projectedBalanceAtTarget || 0)}</b>
                </td>
                <td>${esc(g.status || '-')}</td>
                <td>
                  <div class="rowActions">
                    <button class="btn" onclick="recalcGoal('${g.goalId}')">Recalc</button>
                    <button class="btn danger" onclick="deleteGoal('${g.goalId}')">Hapus</button>
                  </div>
                </td>
              </tr>
            `).join('') : `<tr><td colspan="6" class="muted">Belum ada goals.</td></tr>`)}
          </tbody>
        </table>
      </div>
    `;
  }

  // =========================
  // Quick Add
  // =========================
  async function quickAdd(){
    const date = document.getElementById('qaDate').value || todayISO();
    const amount = Number(document.getElementById('qaAmount').value);
    const category = document.getElementById('qaCategory').value.trim();
    const note = document.getElementById('qaNote').value.trim();

    const type = (state.activeTab === 'outbound') ? 'outbound' : 'inflow';
    if (!amount || amount <= 0) return toast('Amount harus > 0', 'bad');

    showLoader('Menyimpanâ€¦', 'Menulis transaksi ke databaseâ€¦');
    try{
      const row = await apiAddTransaction(type, { date, amount, category, note });

      if (type === 'inflow') state.inflow.unshift(row);
      else state.outbound.unshift(row);

      state.summary = await apiGetSummary();

      render();
      toast('Transaksi ditambahkan âœ…', 'good');
      document.getElementById('qaAmount').value = '';
      document.getElementById('qaCategory').value = '';
      document.getElementById('qaNote').value = '';
    } catch(e){
      toast(e.message || String(e), 'bad');
      console.error(e);
    } finally {
      hideLoader();
    }
  }

  // =========================
  // Transaction modal (Add/Edit)
  // =========================
  function openTxModal(type, txId=null){
    const isEdit = Boolean(txId);
    const list = type === 'inflow' ? state.inflow : state.outbound;
    const tx = isEdit ? list.find(x => x.txId === txId) : { date: todayISO(), amount:'', category:'', note:'' };

    openModal(
      (isEdit ? 'Edit' : 'Tambah') + (type === 'inflow' ? ' Inflow' : ' Outbound'),
      `
        <div class="formGrid">
          <div>
            <label>Tanggal</label>
            <input id="mDate" type="date" value="${esc(tx.date || todayISO())}" />
          </div>
          <div>
            <label>Amount</label>
            <input id="mAmount" type="number" min="0" step="1" value="${esc(tx.amount || '')}" placeholder="contoh: 50000" />
          </div>
          <div>
            <label>Kategori</label>
            <input id="mCategory" value="${esc(tx.category || '')}" placeholder="contoh: Gaji / Makan" />
          </div>
          <div>
            <label>Catatan</label>
            <input id="mNote" value="${esc(tx.note || '')}" placeholder="opsional" />
          </div>
        </div>
        <div class="footerActions">
          <button class="btn" onclick="closeModal()">Batal</button>
          <button class="btn primary" onclick="${isEdit ? `saveTxEdit('${type}','${txId}')` : `saveTxAdd('${type}')`}">
            Simpan
          </button>
        </div>
      `
    );
  }

  async function saveTxAdd(type){
    const payload = {
      date: document.getElementById('mDate').value,
      amount: Number(document.getElementById('mAmount').value),
      category: document.getElementById('mCategory').value.trim(),
      note: document.getElementById('mNote').value.trim()
    };
    showLoader('Menyimpanâ€¦','Tambah transaksiâ€¦');
    try{
      const row = await apiAddTransaction(type, payload);

      if (type === 'inflow') state.inflow.unshift(row);
      else state.outbound.unshift(row);

      state.summary = await apiGetSummary();

      closeModal();
      render();
      toast('Tersimpan âœ…', 'good');
    } catch(e){
      toast(e.message || String(e), 'bad');
      console.error(e);
    } finally {
      hideLoader();
    }
  }

  async function saveTxEdit(type, txId){
    const payload = {
      date: document.getElementById('mDate').value,
      amount: Number(document.getElementById('mAmount').value),
      category: document.getElementById('mCategory').value.trim(),
      note: document.getElementById('mNote').value.trim()
    };
    showLoader('Menyimpanâ€¦','Update transaksiâ€¦');
    try{
      await apiUpdateTransaction(type, txId, payload);

      const list = type === 'inflow' ? state.inflow : state.outbound;
      const idx = list.findIndex(x => x.txId === txId);
      if (idx >= 0) list[idx] = { ...list[idx], ...payload };

      state.summary = await apiGetSummary();

      closeModal();
      render();
      toast('Diupdate âœ…', 'good');
    } catch(e){
      toast(e.message || String(e), 'bad');
      console.error(e);
    } finally {
      hideLoader();
    }
  }

  async function deleteTx(type, txId){
    if (!confirm('Yakin hapus transaksi ini?')) return;
    showLoader('Menghapusâ€¦','Buang transaksiâ€¦');
    try{
      await apiDeleteTransaction(type, txId);

      if (type === 'inflow') state.inflow = state.inflow.filter(x => x.txId !== txId);
      else state.outbound = state.outbound.filter(x => x.txId !== txId);

      state.summary = await apiGetSummary();

      render();
      toast('Dihapus âœ…', 'good');
    } catch(e){
      toast(e.message || String(e), 'bad');
      console.error(e);
    } finally {
      hideLoader();
    }
  }

  // =========================
  // Goals modal (Add)
  // =========================
  function openGoalModal(){
    openModal('Tambah Goal', `
      <div class="formGrid">
        <div>
          <label>Nama Goal</label>
          <input id="gName" placeholder="contoh: Dana Darurat" />
        </div>
        <div>
          <label>Target Amount</label>
          <input id="gAmount" type="number" min="0" step="1" placeholder="contoh: 10000000" />
        </div>
        <div>
          <label>Target Date</label>
          <input id="gDate" type="date" value="${todayISO()}" />
        </div>
        <div>
          <label>Catatan</label>
          <input id="gNote" placeholder="opsional (tidak disimpan, sekadar pengingat UI)" />
        </div>
      </div>
      <div class="footerActions">
        <button class="btn" onclick="closeModal()">Batal</button>
        <button class="btn primary" onclick="saveGoal()">Simpan</button>
      </div>
    `);
  }

  async function saveGoal(){
    const payload = {
      goalName: document.getElementById('gName').value.trim(),
      goalAmount: Number(document.getElementById('gAmount').value),
      targetDate: document.getElementById('gDate').value
    };
    if (!payload.goalName) return toast('Nama goal wajib.', 'bad');
    if (!payload.goalAmount || payload.goalAmount <= 0) return toast('Target amount harus > 0', 'bad');
    if (!payload.targetDate) return toast('Target date wajib.', 'bad');

    showLoader('Menyimpan Goalâ€¦','Hitung proyeksiâ€¦');
    try{
      // ensure summary is up-to-date
      state.summary = await apiGetSummary();

      const goal = await apiAddGoal(payload);
      const calc = computeForecast(payload.goalAmount, payload.targetDate);
      await apiUpdateGoalCalc(goal.goalId, calc);

      // update local
      const merged = { ...goal,
        lastCalcAt: new Date().toISOString(),
        currentBalanceAtCalc: calc.currentBalance,
        monthsRemainingAtCalc: calc.monthsRemaining,
        requiredMonthlyNet: calc.requiredMonthlyNet,
        projectedMonthlyNet: calc.projectedMonthlyNet,
        projectedBalanceAtTarget: calc.projectedBalanceAtTarget,
        status: calc.status
      };
      state.goals.unshift(merged);

      closeModal();
      render();
      toast('Goal ditambahkan âœ…', 'good');
    } catch(e){
      toast(e.message || String(e), 'bad');
      console.error(e);
    } finally {
      hideLoader();
    }
  }

  async function recalcGoal(goalId){
    showLoader('Recalcâ€¦','Menghitung ulang proyeksiâ€¦');
    try{
      state.summary = await apiGetSummary();
      const goal = state.goals.find(g => g.goalId === goalId);
      if (!goal) throw new Error('Goal tidak ditemukan di UI.');

      const calc = computeForecast(goal.goalAmount, goal.targetDate);
      await apiUpdateGoalCalc(goalId, calc);

      // reload goals (biar konsisten)
      state.goals = await apiListGoals();

      render();
      toast('Proyeksi diperbarui âœ…', 'good');
    } catch(e){
      toast(e.message || String(e), 'bad');
      console.error(e);
    } finally {
      hideLoader();
    }
  }

  async function deleteGoal(goalId){
    if (!confirm('Yakin hapus goal ini?')) return;
    showLoader('Menghapusâ€¦','Buang goalâ€¦');
    try{
      await apiDeleteGoal(goalId);
      state.goals = state.goals.filter(x => x.goalId !== goalId);
      render();
      toast('Goal dihapus âœ…', 'good');
    } catch(e){
      toast(e.message || String(e), 'bad');
      console.error(e);
    } finally {
      hideLoader();
    }
  }

  // =========================
  // Boot
  // =========================
  (function init(){
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('appView').style.display = 'none';
    autoLogin();
  })();
  </script>

</body>
</html>
